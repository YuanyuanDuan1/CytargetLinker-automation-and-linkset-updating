name: Check and Download TransmiR Updates

on:
  schedule:
    # Runs at 00:00 UTC on the 1st of every month
    - cron: '0 0 1 * *'
  workflow_dispatch: # Allows manual triggering for testing

jobs:
  check-and-download:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y curl grep
      
      - name: Check CyTargetLinker version
        id: cytargetlinker_version
        run: |
          CYTARGET_PAGE=$(curl -s https://cytargetlinker.github.io/pages/linksets/transmir.html)
          CYTARGET_VERSION=$(echo "$CYTARGET_PAGE" | grep -oP 'TransmiR release \K[0-9.]+' | head -1)
          if [ -z "$CYTARGET_VERSION" ]; then
            echo "Could not find version on CyTargetLinker page"
            CYTARGET_VERSION="1.2"
          fi
          echo "CyTargetLinker has TransmiR version: $CYTARGET_VERSION"
          echo "version=$CYTARGET_VERSION" >> $GITHUB_OUTPUT
      
      - name: Check TransmiR current version
        id: transmir_version
        run: |
          TRANSMIR_PAGE=$(curl -s http://www.cuilab.cn/transmir)
          TRANSMIR_VERSION=$(echo "$TRANSMIR_PAGE" | grep -oP 'TransmiR v\K[0-9.]+' | head -1)
          if [ -z "$TRANSMIR_VERSION" ]; then
            echo "Could not find version on TransmiR website"
            exit 1
          fi
          echo "TransmiR current version: $TRANSMIR_VERSION"
          echo "version=$TRANSMIR_VERSION" >> $GITHUB_OUTPUT
      
      - name: Compare versions
        id: compare
        run: |
          CYTARGET_VER="${{ steps.cytargetlinker_version.outputs.version }}"
          TRANSMIR_VER="${{ steps.transmir_version.outputs.version }}"
          echo "Comparing versions: CyTargetLinker=$CYTARGET_VER vs TransmiR=$TRANSMIR_VER"
          CYTARGET_NUM=$(echo $CYTARGET_VER | awk -F. '{printf "%d%03d%03d", $1, $2, $3}')
          TRANSMIR_NUM=$(echo $TRANSMIR_VER | awk -F. '{printf "%d%03d%03d", $1, $2, $3}')
          if [ "$TRANSMIR_NUM" -gt "$CYTARGET_NUM" ]; then
            echo "New version available! TransmiR $TRANSMIR_VER > CyTargetLinker $CYTARGET_VER"
            echo "should_download=true" >> $GITHUB_OUTPUT
          else
            echo "No new version. TransmiR $TRANSMIR_VER <= CyTargetLinker $CYTARGET_VER"
            echo "should_download=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Create data directory
        if: steps.compare.outputs.should_download == 'true'
        run: mkdir -p data/transmir
      
      - name: Download literature-curated data (all species TXT)
        if: steps.compare.outputs.should_download == 'true'
        shell: bash
        run: |
          echo "Detecting latest TransmiR literature-curated data URL..."

          # Fetch TransmiR page and try to find db_literaturev*.txt dynamically
          DOWNLOAD_PAGE=$(curl -s http://www.cuilab.cn/transmir)
          DOWNLOAD_URL=$(echo "$DOWNLOAD_PAGE" | grep -oP 'http://www\.cuilab\.cn/files/transmir[0-9]+/download/db_literaturev[0-9]+\.txt' | head -1)

          # Fallback if not found
          if [[ -z "$DOWNLOAD_URL" ]]; then
            echo "âš ï¸ Could not auto-detect download URL, using fallback..."
            DOWNLOAD_URL="http://www.cuilab.cn/files/transmir3/download/db_literaturev3.txt"
          fi

          echo "ðŸ“¥ Downloading from: $DOWNLOAD_URL"
          mkdir -p data/transmir

          # Download the data file (contains all species)
          if ! curl -L -o data/transmir/db_literature_all_species.txt "$DOWNLOAD_URL"; then
            echo "âŒ Failed to download TransmiR data"
            exit 1
          fi

          # Write metadata file safely (avoid YAML interpolation issues)
          {
            echo "TransmiR Version: ${TRANS_VER}"
            echo "Downloaded on: $(date)"
            echo "Previous CyTargetLinker version: ${CYTARGET_VER}"
            echo "Source URL: ${DOWNLOAD_URL}"
          } > data/transmir/version.txt
        env:
          TRANS_VER: ${{ steps.transmir_version.outputs.version }}
          CYTARGET_VER: ${{ steps.cytargetlinker_version.outputs.version }}
